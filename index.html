<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–∞–≥–∞–∑–∏–Ω —Å –∫–æ—Ä–∑–∏–Ω–æ–π –∏ –∑–∞–∫–∞–∑–æ–º</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
    }
    .products {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 20px;
    }
    .product {
      width: 150px;
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      position: relative;
    }
    .product img {
      width: 100px;
      height: 100px;
      object-fit: contain;
      cursor: pointer;
    }
    .cart-button {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      z-index: 1000;
    }
    .cart-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      font-size: 12px;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .cart {
      position: fixed;
      top: 50px;
      right: 10px;
      width: 300px;
      max-height: 80vh;
      overflow-y: auto;
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 15px;
      display: none;
      z-index: 999;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      border-radius: 5px;
    }
    .cart.open {
      display: block;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }
    .cart-item-name {
      flex: 1;
    }
    .cart-item-controls button {
      margin: 0 3px;
      padding: 2px 6px;
    }
    form {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
    }
    form label {
      margin-top: 10px;
    }
    form input {
      padding: 5px;
      font-size: 16px;
    }
    form button[type="submit"] {
      margin-top: 15px;
      padding: 10px;
      background: green;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    #message {
      margin-top: 15px;
      min-height: 20px;
    }
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª–µ—Ç–∞ —Ç–æ–≤–∞—Ä–∞ */
    .flying-img {
      position: fixed;
      width: 100px;
      height: 100px;
      object-fit: contain;
      pointer-events: none;
      z-index: 10000;
      transition: transform 0.7s ease-in-out, opacity 0.7s ease-in-out;
    }
  </style>
</head>
<body>

<button class="cart-button" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É">
  üõí <span class="cart-count" id="cart-count">0</span>
</button>

<div class="products" id="products">
  <!-- –ü—Ä–∏–º–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤ -->
  <div class="product" data-id="1" data-name="–¢–æ–≤–∞—Ä 1" data-price="1200" data-image="https://via.placeholder.com/100?text=1">
    <img src="https://via.placeholder.com/100?text=1" alt="–¢–æ–≤–∞—Ä 1" />
    <div>–¢–æ–≤–∞—Ä 1</div>
    <div>1200 ‚Ç∏</div>
    <button class="add-to-cart">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
  <div class="product" data-id="2" data-name="–¢–æ–≤–∞—Ä 2" data-price="2300" data-image="https://via.placeholder.com/100?text=2">
    <img src="https://via.placeholder.com/100?text=2" alt="–¢–æ–≤–∞—Ä 2" />
    <div>–¢–æ–≤–∞—Ä 2</div>
    <div>2300 ‚Ç∏</div>
    <button class="add-to-cart">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
  <!-- –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
</div>

<div class="cart" id="cart" aria-label="–ö–æ—Ä–∑–∏–Ω–∞ –∑–∞–∫–∞–∑–æ–≤">
  <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
  <div id="cart-items"></div>
  <div><strong>–ò—Ç–æ–≥–æ: </strong><span id="cart-total">0</span> ‚Ç∏</div>

  <form id="order-form" aria-label="–§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞">
    <label for="name">–ò–º—è:</label>
    <input type="text" id="name" name="name" required />
    <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
    <input type="tel" id="phone" name="phone" required pattern="^\+?\d{7,15}$" placeholder="+7xxxxxxxxxx" />
    <label for="address">–ê–¥—Ä–µ—Å:</label>
    <input type="text" id="address" name="address" required />
    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </form>

  <div id="message" role="alert"></div>
</div>

<script type="module">
// --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase ---
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://your-project.supabase.co'; // –í–∞—à–∞ —Å—Å—ã–ª–∫–∞ Supabase
const SUPABASE_KEY = 'public-anon-key'; // –í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// --- –õ–æ–≥–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ---
const cartButton = document.querySelector('.cart-button');
const cartCount = document.getElementById('cart-count');
const cartElem = document.getElementById('cart');
const cartItemsElem = document.getElementById('cart-items');
const cartTotalElem = document.getElementById('cart-total');
const orderForm = document.getElementById('order-form');
const messageDiv = document.getElementById('message');
const productsElem = document.getElementById('products');

let cart = [];

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –∏–∑ localStorage
function loadCart() {
  const stored = localStorage.getItem('cart');
  cart = stored ? JSON.parse(stored) : [];
}
function saveCart() {
  localStorage.setItem('cart', JSON.stringify(cart));
}
function updateCartCount() {
  let count = cart.reduce((sum, p) => sum + p.qty, 0);
  cartCount.textContent = count;
}
function renderCart() {
  cartItemsElem.innerHTML = '';
  if (cart.length === 0) {
    cartItemsElem.innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
    cartTotalElem.textContent = '0';
    return;
  }
  cart.forEach(item => {
    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = `
      <div class="cart-item-name">${item.name}</div>
      <div class="cart-item-controls">
        <button aria-label="–£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" data-id="${item.id}" data-action="decrease">‚àí</button>
        <span>${item.qty}</span>
        <button aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" data-id="${item.id}" data-action="increase">+</button>
      </div>
      <div>${(item.price * item.qty).toLocaleString('ru-RU')} ‚Ç∏</div>
    `;
    cartItemsElem.appendChild(div);
  });
  let total = cart.reduce((sum, p) => sum + p.price * p.qty, 0);
  cartTotalElem.textContent = total.toLocaleString('ru-RU');
}
function addToCart(product) {
  const exist = cart.find(p => p.id === product.id);
  if (exist) {
    exist.qty++;
  } else {
    cart.push({...product, qty: 1});
  }
  saveCart();
  updateCartCount();
  renderCart();
}
function changeQty(id, delta) {
  const item = cart.find(p => p.id === id);
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) {
    cart = cart.filter(p => p.id !== id);
  }
  saveCart();
  updateCartCount();
  renderCart();
}

// –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª—ë—Ç–∞ —Ç–æ–≤–∞—Ä–∞ –∫ –∫–æ—Ä–∑–∏–Ω–µ
function flyToCart(imgElem) {
  const imgRect = imgElem.getBoundingClientRect();
  const cartRect = cartButton.getBoundingClientRect();

  const flyingImg = imgElem.cloneNode();
  flyingImg.classList.add('flying-img');
  flyingImg.style.top = imgRect.top + 'px';
  flyingImg.style.left = imgRect.left + 'px';
  flyingImg.style.width = imgRect.width + 'px';
  flyingImg.style.height = imgRect.height + 'px';
  document.body.appendChild(flyingImg);

  const deltaX = cartRect.left + cartRect.width / 2 - imgRect.left - imgRect.width / 2;
  const deltaY = cartRect.top + cartRect.height / 2 - imgRect.top - imgRect.height / 2;

  requestAnimationFrame(() => {
    flyingImg.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(0.1)`;
    flyingImg.style.opacity = '0.5';
  });

  flyingImg.addEventListener('transitionend', () => {
    flyingImg.remove();
  });
}

// –°–æ–±—ã—Ç–∏—è
productsElem.addEventListener('click', (e) => {
  if (!e.target.classList.contains('add-to-cart')) return;
  const productElem = e.target.closest('.product');
  if (!productElem) return;

  const product = {
    id: productElem.dataset.id,
    name: productElem.dataset.name,
    price: Number(productElem.dataset.price),
    image: productElem.dataset.image,
  };

  addToCart(product);

  const imgElem = productElem.querySelector('img');
  if (imgElem) flyToCart(imgElem);
});

cartButton.addEventListener('click', () => {
  cartElem.classList.toggle('open');
});

cartItemsElem.addEventListener('click', (e) => {
  if (!e.target.tagName === 'BUTTON') return;
  const btn = e.target;
  const id = btn.dataset.id;
  const action = btn.dataset.action;
  if (!id || !action) return;
  if (action === 'increase') changeQty(id, +1);
  else if (action === 'decrease') changeQty(id, -1);
});

// –ó–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
function loadFormData() {
  ['name','phone','address'].forEach(field => {
    const val = localStorage.getItem(field);
    if(val) orderForm[field].value = val;
  });
}
function saveFormData() {
  ['name','phone','address'].forEach(field => {
    localStorage.setItem(field, orderForm[field].value);
  });
}
orderForm.addEventListener('input', saveFormData);

orderForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  messageDiv.textContent = '';
  if(cart.length === 0) {
    messageDiv.style.color = 'red';
    messageDiv.textContent = '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
    return;
  }
  if(!orderForm.checkValidity()) {
    messageDiv.style.color = 'red';
    messageDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ';
    return;
  }

  // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–∫–∞–∑
  const order = {
    name: orderForm.name.value.trim(),
    phone: orderForm.phone.value.trim(),
    address: orderForm.address.value.trim(),
    products: cart.map(p => ({ id: p.id, name: p.name, price: p.price, qty: p.qty })),
    total: cart.reduce((sum, p) => sum + p.price * p.qty, 0),
    created_at: new Date().toISOString(),
  };

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Supabase (–∑–∞–º–µ–Ω–∏—Ç–µ 'orders' –Ω–∞ –≤–∞—à—É —Ç–∞–±–ª–∏—Ü—É)
  try {
    const { error } = await supabase.from('orders').insert([order]);
    if (error) throw error;
  } catch (err) {
    messageDiv.style.color = 'red';
    messageDiv.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
    console.error(err);
    return;
  }

  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ WhatsApp
  const whatsappText = encodeURIComponent(
    `–ù–æ–≤—ã–π –∑–∞–∫–∞–∑:\n–ò–º—è: ${order.name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${order.phone}\n–ê–¥—Ä–µ—Å: ${order.address}\n` +
    `–¢–æ–≤–∞—Ä—ã:\n${order.products.map(p => `- ${p.name} (${p.qty} —à—Ç.) –ø–æ ${p.price} ‚Ç∏`).join('\n')}\n` +
    `–ò—Ç–æ–≥–æ: ${order.total.toLocaleString('ru-RU')} ‚Ç∏`
  );
  const whatsappNumber = '+77777777777'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω–æ–º–µ—Ä –ø—Ä–æ–¥–∞–≤—Ü–∞
  const whatsappURL = `https://wa.me/${whatsappNumber.replace(/\D/g,'')}?text=${whatsappText}`;
  window.open(whatsappURL, '_blank');

  // –û—á–∏—Å—Ç–∫–∞
  cart = [];
  saveCart();
  renderCart();
  updateCartCount();
  orderForm.reset();
  ['name','phone','address'].forEach(f => localStorage.removeItem(f));

  messageDiv.style.color = 'green';
  messageDiv.textContent = '–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ!';
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
loadCart();
renderCart();
updateCartCount();
loadFormData();

</script>

</body>
</html>
