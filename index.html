<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Магазин на Supabase</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2a9d8f" />
  <link rel="icon" href="icon-192.png" />
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #f9f9f9; }
    h1 { text-align: center; }
    #products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      justify-content: center;
    }
    @media (max-width: 600px) {
      #products {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (min-width: 601px) and (max-width: 900px) {
      #products {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    .product-card {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 8px;
      background: #fff;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .product-card img {
      max-width: 100%;
      height: 100px;
      object-fit: contain;
    }
    .product-name {
      font-weight: bold;
      margin: 5px 0 3px 0;
    }
    .product-price {
      color: #333;
      margin-bottom: 5px;
    }
    button {
      background: #2a9d8f;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #21867a;
    }
    #cart-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #ffeb3b;
      border-radius: 8px;
      padding: 3px;
      cursor: pointer;
      border: none;
      gap: 4px;
      z-index: 1001;
    }
    #cart-toggle img {
      width: 40px;
      height: 40px;
      display: block;
    }
    #cart-text {
      font-size: 12px;
      color: black;
    }
    #cart {
      width: 90vw;
      max-width: 320px;
      position: fixed;
      right: 10px;
      top: 80px;
      max-height: 85vh;
      overflow-y: auto;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      font-size: 14px;
      transition: transform 0.3s ease;
      transform: translateX(100%);
      z-index: 1000;
    }
    #cart.open {
      transform: translateX(0);
    }
    #cart h2 { margin-top: 0; text-align: center; }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    .cart-item-name { flex: 1 1 auto; }
    .cart-item-qty {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .cart-item-qty button {
      width: 26px;
      height: 26px;
      font-weight: bold;
      padding: 0;
      line-height: 1;
      border-radius: 4px;
    }
    #total {
      font-weight: bold;
      text-align: right;
      margin-top: 10px;
    }
    #orderForm {
      margin-top: 10px;
    }
    #orderForm input,
    #orderForm textarea {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 8px;
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #orderForm button {
      width: 100%;
      font-size: 16px;
    }
    #message {
      text-align: center;
      color: green;
      margin-top: 8px;
    }
    h3 {
      text-align: left;
      margin-top: 5px;
      font-size: 24px;
      color: #ed2d5a;
    }
  </style>
</head>
<body>

<h3>Магазин<br> "Меруерт"</h3>

<div id="products">Загрузка товаров...</div>

<button id="cart-toggle" title="Открыть/закрыть корзину">
  <img id="cart-icon" src="https://cdn-icons-png.flaticon.com/512/1170/1170678.png" alt="Корзина" />
  <span id="cart-text">Открыть/закрыть корзину</span>
</button>

<div id="cart">
  <h2>Корзина</h2>
  <div id="cartItems">Корзина пуста</div>
  <div id="total">Итого: 0</div>
  <form id="orderForm">
    <input type="text" id="name" placeholder="Имя" required />
    <input type="tel" id="phone" placeholder="Телефон" required pattern="^\+?\d{10,15}$" title="Введите корректный номер телефона" />
    <input id="address" type="text" placeholder="Адрес проживания" required autocomplete="on" />
    <button type="submit">Отправить заказ</button>
  </form>
  <div id="message"></div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const SUPABASE_URL = 'https://kpefeonxvgnfpgevkcwy.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZWZlb254dmduZnBnZXZrY3d5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyMzY4MDgsImV4cCI6MjA2MjgxMjgwOH0.aZJhwODNOS3FhyT8k-qAAfvo0NaYbv4QSm6SwuNaeys'

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  const productsContainer = document.getElementById('products')
  const cartItemsContainer = document.getElementById('cartItems')
  const totalDiv = document.getElementById('total')
  const orderForm = document.getElementById('orderForm')
  const messageDiv = document.getElementById('message')
  const cartPanel = document.getElementById('cart')
  const toggleButton = document.getElementById('cart-toggle')

  window.addEventListener("DOMContentLoaded", () => {
    const nameInput = document.getElementById("name")
    const phoneInput = document.getElementById("phone")
    const addressInput = document.getElementById("address")

    // Загрузка сохранённых данных
    nameInput.value = localStorage.getItem("name") || ""
    phoneInput.value = localStorage.getItem("phone") || ""
    addressInput.value = localStorage.getItem("address") || ""

    // Сохранение при вводе
    nameInput.addEventListener("input", () => {
      localStorage.setItem("name", nameInput.value)
    })

    phoneInput.addEventListener("input", () => {
      localStorage.setItem("phone", phoneInput.value)
    })

    addressInput.addEventListener("input", () => {
      localStorage.setItem("address", addressInput.value)
    })
  })

  toggleButton.addEventListener('click', () => {
    cartPanel.classList.toggle('open')
  })

  let products = []
  let cart = []

  async function loadProducts() {
    productsContainer.textContent = 'Загрузка товаров...'
    const { data, error } = await supabase.from('products').select('id,name,price,image_url,unit')
    if (error) {
      productsContainer.textContent = 'Ошибка загрузки товаров'
      console.error(error)
      return
    }
    products = data
renderProducts()
}

function renderProducts() {
if (!products.length) {
productsContainer.textContent = 'Товары не найдены'
return
}
productsContainer.innerHTML = ''
products.forEach(product => {
const card = document.createElement('div')
card.className = 'product-card'
card.innerHTML = <img src="${product.image_url || 'https://cdn-icons-png.flaticon.com/512/1170/1170678.png'}" alt="${product.name}" /> <div class="product-name">${product.name}</div> <div class="product-price">${product.price} ₸ / ${product.unit}</div> <button data-id="${product.id}">В корзину</button>
card.querySelector('button').addEventListener('click', () => {
addToCart(product.id)
flyToCart(card.querySelector('img'))
})
productsContainer.appendChild(card)
})
}

function addToCart(productId) {
const product = products.find(p => p.id === productId)
if (!product) return
const itemInCart = cart.find(item => item.id === product.id)
if (itemInCart) {
itemInCart.qty++
} else {
cart.push({ ...product, qty: 1 })
}
updateCartUI()
}

function updateCartUI() {
if (cart.length === 0) {
cartItemsContainer.textContent = 'Корзина пуста'
totalDiv.textContent = 'Итого: 0 ₸'
return
}
cartItemsContainer.innerHTML = ''
let total = 0
cart.forEach(item => {
total += item.price * item.qty
const itemDiv = document.createElement('div')
itemDiv.className = 'cart-item'
itemDiv.innerHTML = <div class="cart-item-name">${item.name}</div> <div class="cart-item-qty"> <button class="decrease">−</button> <span>${item.qty}</span> <button class="increase">+</button> </div>
itemDiv.querySelector('.increase').addEventListener('click', () => {
item.qty++
updateCartUI()
})
itemDiv.querySelector('.decrease').addEventListener('click', () => {
item.qty--
if (item.qty <= 0) {
cart = cart.filter(c => c.id !== item.id)
}
updateCartUI()
})
cartItemsContainer.appendChild(itemDiv)
})
totalDiv.textContent = Итого: ${total} ₸
}

orderForm.addEventListener('submit', async e => {
e.preventDefault()
if (cart.length === 0) {
alert('Корзина пуста')
return
}
const name = document.getElementById('name').value.trim()
const phone = document.getElementById('phone').value.trim()
const address = document.getElementById('address').value.trim()
const productsSummary = cart.map(item => ${item.name} (${item.qty} × ${item.price})).join(', ')
const total = cart.reduce((sum, item) => sum + item.qty * item.price, 0)

javascript
Копировать
Редактировать
const { error } = await supabase.from('orders').insert([{
  name,
  phone,
  address,
  products: productsSummary,
  total
}])

if (error) {
  console.error(error)
  messageDiv.textContent = 'Ошибка при отправке заказа'
  messageDiv.style.color = 'red'
} else {
  messageDiv.textContent = 'Заказ успешно отправлен!'
  messageDiv.style.color = 'green'
  cart = []
  updateCartUI()
  orderForm.reset()
  localStorage.removeItem('name')
  localStorage.removeItem('phone')
  localStorage.removeItem('address')
}
})

function flyToCart(imgElement) {
if (!imgElement) return
const imgRect = imgElement.getBoundingClientRect()
const cartIcon = document.getElementById('cart-icon')
const cartRect = cartIcon.getBoundingClientRect()

javascript
Копировать
Редактировать
const imgClone = imgElement.cloneNode(true)
imgClone.style.position = 'fixed'
imgClone.style.left = imgRect.left + 'px'
imgClone.style.top = imgRect.top + 'px'
imgClone.style.width = imgRect.width + 'px'
imgClone.style.height = imgRect.height + 'px'
imgClone.style.transition = 'all 0.7s ease-in-out'
imgClone.style.zIndex = 10000
imgClone.style.pointerEvents = 'none'
document.body.appendChild(imgClone)

// Force reflow to apply initial position before animation
imgClone.getBoundingClientRect()

requestAnimationFrame(() => {
  imgClone.style.left = cartRect.left + 'px'
  imgClone.style.top = cartRect.top + 'px'
  imgClone.style.width = '30px'
  imgClone.style.height = '30px'
  imgClone.style.opacity = '0.5'
})

imgClone.addEventListener('transitionend', () => {
  imgClone.remove()
})
}

loadProducts()
updateCartUI()
</script>

</body> </html> ```
