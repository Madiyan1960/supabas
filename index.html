<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Магазин на Supabase</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2a9d8f" />
  <link rel="icon" href="icon-192.png" />
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #f9f9f9; }
    h1 { text-align: center; }
    #products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      justify-content: center;
    }
    @media (max-width: 600px) {
      #products { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 601px) and (max-width: 900px) {
      #products { grid-template-columns: repeat(3, 1fr); }
    }
    .product-card {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 8px;
      background: #fff;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .product-card img {
      max-width: 100%;
      height: 100px;
      object-fit: contain;
    }
    .product-name {
      font-weight: bold;
      margin: 5px 0 3px 0;
    }
    .product-price {
      color: #333;
      margin-bottom: 5px;
    }
    button {
      background: #2a9d8f;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #21867a;
    }
    #cart-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #ffeb3b;
      border-radius: 8px;
      padding: 3px;
      cursor: pointer;
      border: none;
      gap: 4px;
      z-index: 1001;
    }
    #cart-toggle img {
      width: 40px;
      height: 40px;
      display: block;
    }
    #cart-text {
      font-size: 12px;
      color: black;
    }
    #cart {
      width: 90vw;
      max-width: 320px;
      position: fixed;
      right: 10px;
      top: 80px;
      max-height: 85vh;
      overflow-y: auto;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      font-size: 14px;
      transition: transform 0.3s ease;
      transform: translateX(100%);
      z-index: 1000;
    }
    #cart.open {
      transform: translateX(0);
    }
    #cart h2 {
      margin-top: 0;
      text-align: center;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    .cart-item-name {
      flex: 1 1 auto;
    }
    .cart-item-qty {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .cart-item-qty button {
      width: 26px;
      height: 26px;
      font-weight: bold;
      padding: 0;
      line-height: 1;
      border-radius: 4px;
      background: #2a9d8f;
      color: white;
      border: none;
      cursor: pointer;
    }
    .cart-item-qty button:hover {
      background: #21867a;
    }
    #total {
      font-weight: bold;
      text-align: right;
      margin-top: 10px;
    }
    #orderForm {
      margin-top: 10px;
    }
    #orderForm input,
    #orderForm textarea {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 8px;
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #orderForm button {
      width: 100%;
      font-size: 16px;
      background: #2a9d8f;
      color: white;
      border: none;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
    }
    #orderForm button:hover {
      background: #21867a;
    }
    #message {
      text-align: center;
      color: green;
      margin-top: 8px;
    }
    h3 {
      text-align: left;
      margin-top: 5px;
      font-size: 24px;
      color: #ed2d5a;
    }
  </style>
</head>
<body>

<h3>Магазин<br> "Меруерт"</h3>

<div id="products">Загрузка товаров...</div>

<button id="cart-toggle" title="Открыть/закрыть корзину">
  <img id="cart-icon" src="https://cdn-icons-png.flaticon.com/512/1170/1170678.png" alt="Корзина" />
  <span id="cart-text">Открыть/закрыть корзину</span>
</button>

<div id="cart">
  <h2>Корзина</h2>
  <div id="cartItems">Корзина пуста</div>
  <div id="total">Итого: 0</div>
  <form id="orderForm">
    <input type="text" id="name" placeholder="Имя" required />
    <input type="tel" id="phone" placeholder="Телефон" required pattern="^\+?\d{10,15}$" title="Введите корректный номер телефона" />
    <input id="address" type="text" placeholder="Адрес проживания" required autocomplete="on" />
    <button type="submit">Отправить заказ</button>
  </form>
  <div id="message"></div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const SUPABASE_URL = 'https://kpefeonxvgnfpgevkcwy.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZWZlb254dmduZnBnZXZrY3d5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyMzY4MDgsImV4cCI6MjA2MjgxMjgwOH0.aZJhwODNOS3FhyT8k-qAAfvo0NaYbv4QSm6SwuNaeys'

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  const productsContainer = document.getElementById('products')
  const cartItemsContainer = document.getElementById('cartItems')
  const totalDiv = document.getElementById('total')
  const orderForm = document.getElementById('orderForm')
  const messageDiv = document.getElementById('message')
  const cartPanel = document.getElementById('cart')
  const toggleButton = document.getElementById('cart-toggle')

  // Загрузка сохранённых данных формы из localStorage
  window.addEventListener("DOMContentLoaded", () => {
    const nameInput = document.getElementById("name");
    const phoneInput = document.getElementById("phone");
    const addressInput = document.getElementById("address");

    nameInput.value = localStorage.getItem("name") || "";
    phoneInput.value = localStorage.getItem("phone") || "";
    addressInput.value = localStorage.getItem("address") || "";

    nameInput.addEventListener("input", () => {
      localStorage.setItem("name", nameInput.value);
    });
    phoneInput.addEventListener("input", () => {
      localStorage.setItem("phone", phoneInput.value);
    });
    addressInput.addEventListener("input", () => {
      localStorage.setItem("address", addressInput.value);
   
});
});

let cart = JSON.parse(localStorage.getItem('cart')) || []

function saveCart() {
localStorage.setItem('cart', JSON.stringify(cart))
}

function renderCart() {
cartItemsContainer.innerHTML = ''
if (cart.length === 0) {
cartItemsContainer.innerHTML = 'Корзина пуста'
} else {
cart.forEach((item, index) => {
const div = document.createElement('div')
div.className = 'cart-item'
div.innerHTML = <span class="cart-item-name">${index + 1}. ${item.name}</span> <div class="cart-item-qty"> <button class="minus" data-id="${item.id}">−</button> ${item.quantity} <button class="plus" data-id="${item.id}">+</button> </div>
cartItemsContainer.appendChild(div)
})
}
const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0)
totalDiv.textContent = 'Итого: ' + total.toFixed(2) + ' ₸'
saveCart()
}

function addToCart(product) {
const existing = cart.find(item => item.id === product.id)
if (existing) {
existing.quantity++
} else {
cart.push({ ...product, quantity: 1 })
}
renderCart()
}

toggleButton.addEventListener('click', () => {
cartPanel.classList.toggle('open')
})

cartItemsContainer.addEventListener('click', e => {
if (e.target.classList.contains('plus')) {
const id = e.target.dataset.id
const item = cart.find(i => i.id == id)
item.quantity++
renderCart()
} else if (e.target.classList.contains('minus')) {
const id = e.target.dataset.id
const item = cart.find(i => i.id == id)
item.quantity--
if (item.quantity <= 0) {
cart = cart.filter(i => i.id != id)
}
renderCart()
}
})

orderForm.addEventListener('submit', async e => {
e.preventDefault()
const name = document.getElementById('name').value
const phone = document.getElementById('phone').value
const address = document.getElementById('address').value
const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0)
const productList = cart.map(item => ${item.name} x${item.quantity}).join(', ')
  const { error } = await supabase.from('orders').insert([
  { name, phone, address, products: productList, total }
])

if (error) {
  messageDiv.textContent = 'Ошибка при отправке заказа'
  messageDiv.style.color = 'red'
} else {
  messageDiv.textContent = 'Заказ успешно отправлен!'
  messageDiv.style.color = 'green'
  cart = []
  renderCart()
  orderForm.reset()
  localStorage.removeItem('cart')
}
})

const { data, error } = await supabase.from('products').select('*')
if (error) {
productsContainer.textContent = 'Ошибка загрузки товаров'
} else {
productsContainer.innerHTML = ''
data.forEach(product => {
const div = document.createElement('div')
div.className = 'product-card'
div.innerHTML = <img src="${product.image}" alt="${product.name}" /> <div class="product-name">${product.name}</div> <div class="product-price">${product.price} ₸</div> <button data-id="${product.id}">В корзину</button>
div.querySelector('button').addEventListener('click', () => {
const img = div.querySelector('img')
const clone = img.cloneNode(true)
const rect = img.getBoundingClientRect()
clone.style.position = 'fixed'
clone.style.left = rect.left + 'px'
clone.style.top = rect.top + 'px'
clone.style.width = rect.width + 'px'
clone.style.height = rect.height + 'px'
clone.style.transition = 'all 1s ease'
clone.style.zIndex = '1000'
document.body.appendChild(clone)
setTimeout(() => {
clone.style.left = toggleButton.getBoundingClientRect().left + 'px'
clone.style.top = toggleButton.getBoundingClientRect().top + 'px'
clone.style.opacity = 0
clone.style.transform = 'scale(0.2)'
}, 10)
setTimeout(() => document.body.removeChild(clone), 1000)
      addToCart(product)
  })
  productsContainer.appendChild(div)
})
}

renderCart()
</script>

</body> </html> ```
